# Compiling libPGF on MSVC

This repository contains a few changes made to the Grammatical Framework ([homepage](http://grammaticalframework.org), [repository](http://github.com/grammaticalframework/gf)) to compile its C runtime component on the Microsoft Visual C++ compiler (MSVC).

I have tried to keep the changes minimal. MSVC does not fully conform to the C99 standard, so consider this a work-around.

This procudes a build from the clean repository:
```shell
mkdir build
cd build
\path\to\cmake\bin\cmake.exe ..
\path\to\cmake\bin\cmake.exe --build . --config Release
cd Release
```

## Build files generated by CMake
CMake can create build scripts for make, Visual Studio and others. It seems like the simplest way of  
getting an automatic build on Windows and MSVC. Have added CMake build configurtion (d02caff0bcb70acf0818b0f71afd725e1fda702b).

There is a problem with debug builds where a DLL file `ucrtbased.dll` is not copied into the build
directory. This can be fixed by locating the file and copying it. Release builds seem to be working.

## DLL Exports
    Building Windows DLLs on MSVC requires explicitly exporting symbols.
    CMake takes care of exporting functions, but for data
    (constants/variables) we need to add __declspec(dllexport) and similar.

Have added `GU_API_DATA_DECL` (6b1128d96b075cc7b7e14f9e1624443cef5cec34)
and `PGF_API_DATA_DECL` (7abc1b4894753d514dd5bd1d51f9dd31f77f340c).

## MSVC C99 support
MSVC does not have full C99 support. Restrict **COMMIT**.
    
 -  MSVC does not support the C99 keyword `restrict`.
  Added a macro which renamed to `__restricted`, which
  has the same meaning in MSVC. (62e9af346a688e5da4370063d546937216c152c4)
 - Some header includes from the standard library work differently 
   (baf47cf2739a3fe9f641fe68a56e9f2038dad542, 
     01a72d6e03d1505199bd4a2f4304b6aaada7fd2a).
## GCC-specific C features
    
 - Allowing pointer arithmetic on `void*` is a GCC extension
 which is not supported by MSVC. Have redefined PgfPattWild to
 char and changed some casts to replace `void*` with `char*` for
 arithmetic. (b253aa64e1cb6e9649a3de98b502d321a4aff968)
 - Structs with empty body are a GCC extension to C
 which is not supported by MSVC.
 Added instead a zero-length array, which should
 have the same effect. (59f186f0e50ce2caeca24aa9b1ca20f744e3810c)
- `__func__` does not exist in MSVC, but `__FUNCTION__` does.
  (95e19fa5fd680f3521acf65131ff51f71b6f1b01)
    

